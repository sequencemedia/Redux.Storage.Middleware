'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key];}}}return target;};var _actions=require('./actions');function _objectWithoutProperties(obj,keys){var target={};for(var i in obj){if(keys.indexOf(i)>=0)continue;if(!Object.prototype.hasOwnProperty.call(obj,i))continue;target[i]=obj[i];}return target;}function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++){arr2[i]=arr[i];}return arr2;}else{return Array.from(arr);}}var isStale=function isStale(){var _ref=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},_ref$cachedAt=_ref.cachedAt,cachedAt=_ref$cachedAt===undefined?0:_ref$cachedAt,_ref$cacheFor=_ref.cacheFor,cacheFor=_ref$cacheFor===undefined?0:_ref$cacheFor;return cachedAt+cacheFor<Date.now();};var isHardStorage=function isHardStorage(){var _ref2=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},_ref2$cacheFor=_ref2.cacheFor,cacheFor=_ref2$cacheFor===undefined?0:_ref2$cacheFor;return cacheFor>=1000*60*60*24;};var isSoftStorage=function isSoftStorage(){var _ref3=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},_ref3$cacheFor=_ref3.cacheFor,cacheFor=_ref3$cacheFor===undefined?0:_ref3$cacheFor;return cacheFor>=1000*60*60&&cacheFor<1000*60*60*24;};var filter=function filter(_ref4){var _ref4$meta=_ref4.meta;_ref4$meta=_ref4$meta===undefined?{}:_ref4$meta;var _ref4$meta$cacheFor=_ref4$meta.cacheFor,cacheFor=_ref4$meta$cacheFor===undefined?0:_ref4$meta$cacheFor;return!!cacheFor;};var filterFor=function filterFor(t){return function(){var _ref5=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},type=_ref5.type;return type===t;};};var filterMetaFor=function filterMetaFor(t){return function(){var _ref6=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},_ref6$meta=_ref6.meta;_ref6$meta=_ref6$meta===undefined?{}:_ref6$meta;var type=_ref6$meta.type;return type===t;};};var map=function map(){var _ref7=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},_ref7$meta$cacheFor=_ref7.meta.cacheFor,cacheFor=_ref7$meta$cacheFor===undefined?0:_ref7$meta$cacheFor;return cacheFor;};var reduce=function reduce(a){var _ref8=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{},type=_ref8.type,meta=_ref8.meta,_ref8$meta=_ref8.meta;_ref8$meta=_ref8$meta===undefined?{}:_ref8$meta;var _ref8$meta$cacheFor=_ref8$meta.cacheFor,cacheFor=_ref8$meta$cacheFor===undefined?0:_ref8$meta$cacheFor;var index=arguments[2];var array=arguments[3];return Math.min.apply(Math,_toConsumableArray(array.filter(filterFor(type)).map(map)))===cacheFor?a.concat(_extends({type:type},meta?{meta:meta}:{})):a;};var dedupe=function dedupe(a){var _ref9=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{},_ref9$meta=_ref9.meta;_ref9$meta=_ref9$meta===undefined?{}:_ref9$meta;var t=_ref9$meta.type,type=_ref9.type,meta=_ref9.meta;return a.map(map).includes(t)?a:a.concat(_extends({type:type},meta?{meta:meta}:{}));};var createAccessedAt=function createAccessedAt(){var meta=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var accessedAt=arguments[1];return _extends({},meta,accessedAt?{accessedAt:accessedAt}:{});};var createCachedAt=function createCachedAt(){var meta=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var cachedAt=arguments[1];return _extends({},meta,cachedAt?{cachedAt:cachedAt}:{});};var createCacheFor=function createCacheFor(){var meta=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var cacheFor=arguments[1];return _extends({},meta,cacheFor?{cacheFor:cacheFor}:{});};var createMeta=function createMeta(meta){var isHardStorage=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;var isSoftStorage=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;return _extends({},meta,isHardStorage?{isHardStorage:isHardStorage}:{},isSoftStorage?{isSoftStorage:isSoftStorage}:{});};var fetchMap=new Map();var storeMap=new Map();exports.default=function(array){if(Array.isArray(array)){array.filter(filter).reduce(reduce,[]).forEach(function(){var _ref10=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},type=_ref10.type,_ref10$meta=_ref10.meta;_ref10$meta=_ref10$meta===undefined?{}:_ref10$meta;var _ref10$meta$cacheFor=_ref10$meta.cacheFor,cacheFor=_ref10$meta$cacheFor===undefined?0:_ref10$meta$cacheFor;if(type){fetchMap.set(type,{type:type,cacheFor:cacheFor});}});array.reduce(dedupe,[]).forEach(function(){var _ref11=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},_ref11$meta=_ref11.meta;_ref11$meta=_ref11$meta===undefined?{}:_ref11$meta;var type=_ref11$meta.type,_ref11$meta$cacheFor=_ref11$meta.cacheFor,cacheFor=_ref11$meta$cacheFor===undefined?0:_ref11$meta$cacheFor,_ref11$meta2=_ref11.meta,meta=_ref11$meta2===undefined?{}:_ref11$meta2;if(type){storeMap.set(type,_extends({},meta,{cacheFor:cacheFor}));}});}return function(store){return function(next){return function(){var _ref12=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var type=_ref12.type,action=_objectWithoutProperties(_ref12,['type']);if(fetchMap.has(type)){var _store$getState=store.getState(),_store$getState$redux=_store$getState.reduxStorage;_store$getState$redux=_store$getState$redux===undefined?{}:_store$getState$redux;var _store$getState$redux2=_store$getState$redux[type];_store$getState$redux2=_store$getState$redux2===undefined?{}:_store$getState$redux2;var _store$getState$redux3=_store$getState$redux2.meta,meta=_store$getState$redux3===undefined?fetchMap.get(type):_store$getState$redux3;var _fetchMap$get=fetchMap.get(type),cacheFor=_fetchMap$get.cacheFor;var META=createMeta(createCacheFor(meta,cacheFor));if(isStale(META)){return next(_extends({},action,{type:type}));}else{array.filter(filterFor(type)).filter(filter).forEach(function(_ref13){var meta=_ref13.meta;var META=createMeta(createAccessedAt(meta,Date.now()),isHardStorage(meta),isSoftStorage(meta));store.dispatch((0,_actions.storageFetchAction)(META));});}}else{if(storeMap.has(type)){var _store$getState2=store.getState(),_store$getState2$redu=_store$getState2.reduxStorage;_store$getState2$redu=_store$getState2$redu===undefined?{}:_store$getState2$redu;var _store$getState2$redu2=_store$getState2$redu[type];_store$getState2$redu2=_store$getState2$redu2===undefined?{}:_store$getState2$redu2;var _store$getState2$redu3=_store$getState2$redu2.meta,_meta=_store$getState2$redu3===undefined?storeMap.get(type):_store$getState2$redu3;var cachedAt=Date.now();var _storeMap$get=storeMap.get(type),_storeMap$get$cacheFo=_storeMap$get.cacheFor,_cacheFor=_storeMap$get$cacheFo===undefined?0:_storeMap$get$cacheFo;if(_cacheFor){var _META=createMeta(createCacheFor(createCachedAt(_extends({},_meta,{type:type}),cachedAt),_cacheFor),isHardStorage(_meta),isSoftStorage(_meta));store.dispatch((0,_actions.storageStoreAction)(_META,_extends({type:type},action)));array.filter(filterMetaFor(type)).filter(filter).forEach(function(_ref14){var type=_ref14.type;var _store$getState3=store.getState(),_store$getState3$redu=_store$getState3.reduxStorage;_store$getState3$redu=_store$getState3$redu===undefined?{}:_store$getState3$redu;var _store$getState3$redu2=_store$getState3$redu[type];_store$getState3$redu2=_store$getState3$redu2===undefined?{}:_store$getState3$redu2;var _store$getState3$redu3=_store$getState3$redu2.meta,meta=_store$getState3$redu3===undefined?fetchMap.get(type):_store$getState3$redu3;var _fetchMap$get2=fetchMap.get(type),cacheFor=_fetchMap$get2.cacheFor;var META=createMeta(createCacheFor(createCachedAt(_extends({},meta,{type:type}),cachedAt),cacheFor),isHardStorage(meta),isSoftStorage(meta));store.dispatch((0,_actions.storageStoreAction)(META));});}else{array.filter(filterMetaFor(type)).forEach(function(_ref15){var type=_ref15.type;array.filter(filterFor(type)).filter(filter).forEach(function(_ref16,index,array){var type=_ref16.type,meta=_ref16.meta;var META=createMeta({type:type},isHardStorage(meta),isSoftStorage(meta));store.dispatch((0,_actions.storageClearAction)(META));array.forEach(function(_ref17){var _ref17$meta=_ref17.meta;_ref17$meta=_ref17$meta===undefined?{}:_ref17$meta;var type=_ref17$meta.type,meta=_ref17.meta;var META=createMeta({type:type},isHardStorage(meta),isSoftStorage(meta));store.dispatch((0,_actions.storageClearAction)(META));});});});}return next(_extends({},action,{type:type}));}else{return next(_extends({},action,{type:type}));}}};};};};