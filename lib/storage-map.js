'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key];}}}return target;};var _actions=require('./actions');function _objectWithoutProperties(obj,keys){var target={};for(var i in obj){if(keys.indexOf(i)>=0)continue;if(!Object.prototype.hasOwnProperty.call(obj,i))continue;target[i]=obj[i];}return target;}var isStale=function isStale(_ref){var _ref$cachedAt=_ref.cachedAt,cachedAt=_ref$cachedAt===undefined?0:_ref$cachedAt;return true;};var isHardStorage=function isHardStorage(_ref2){var _ref2$cachedAt=_ref2.cachedAt,cachedAt=_ref2$cachedAt===undefined?0:_ref2$cachedAt;return cachedAt<=100;};var isSoftStorage=function isSoftStorage(_ref3){var _ref3$cachedAt=_ref3.cachedAt,cachedAt=_ref3$cachedAt===undefined?0:_ref3$cachedAt;return cachedAt<=50&&cachedAt>=10;};var filterFor=function filterFor(t){return function(_ref4){var type=_ref4.type;return type===t;};};var filterMetaFor=function filterMetaFor(t){return function(_ref5){var type=_ref5.meta.type;return type===t;};};var map=function map(_ref6){var t=_ref6.meta.type;return t;};var reduce=function reduce(a,_ref7,index,array){var type=_ref7.type,meta=_ref7.meta,t=_ref7.meta.t;return Math.min.apply(array,array.filter(filterFor(type)).map(map))===t?a.concat({type:type,meta:meta}):a;};var dedupe=function dedupe(a,_ref8){var type=_ref8.type,meta=_ref8.meta,t=_ref8.meta.type;return a.map(map).includes(t)?a:a.concat({type:type,meta:meta});};var createMeta=function createMeta(meta){var isHardStorage=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;var isSoftStorage=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;return _extends({},meta,{isHardStorage:isHardStorage,isSoftStorage:isSoftStorage});};exports.default=function(array){var fetchMap=new Map();var storeMap=new Map();if(Array.isArray(array)){array.reduce(reduce,[]).forEach(function(_ref9){var type=_ref9.type,meta=_ref9.meta;fetchMap.set(type,meta);});array.reduce(dedupe,[]).forEach(function(_ref10){var type=_ref10.meta.type,meta=_ref10.meta;storeMap.set(type,meta);});}return function(store){return function(next){return function(_ref11){var type=_ref11.type,action=_objectWithoutProperties(_ref11,['type']);if(fetchMap.has(type)){var meta=fetchMap.get(type);if(isStale(meta)){return next(_extends({},action,{type:type}));}else{var filter=filterFor(type);array.filter(filter).forEach(function(_ref12){var meta=_ref12.meta;var META=createMeta(meta,isHardStorage(meta),isSoftStorage(meta));store.dispatch((0,_actions.storageFetchAction)(META));});}}else{if(storeMap.has(type)){var _meta=storeMap.get(type);var META=createMeta(_meta,isHardStorage(_meta),isSoftStorage(_meta));store.dispatch((0,_actions.storageStoreAction)(META,_extends({type:type},action)));var _filter=filterMetaFor(type);array.filter(_filter).reduce(dedupe,[]).forEach(function(_ref13){var type=_ref13.type;if(fetchMap.has(type)){var _meta2=_extends({},fetchMap.get(type),{cachedAt:Date.now()});fetchMap.set(type,_meta2);}});}return next(_extends({},action,{type:type}));}};};};};