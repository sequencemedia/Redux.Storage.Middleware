'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key];}}}return target;};var _actions=require('./actions');function _objectWithoutProperties(obj,keys){var target={};for(var i in obj){if(keys.indexOf(i)>=0)continue;if(!Object.prototype.hasOwnProperty.call(obj,i))continue;target[i]=obj[i];}return target;}function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++){arr2[i]=arr[i];}return arr2;}else{return Array.from(arr);}}var isStale=function isStale(){var _ref=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},_ref$cachedAt=_ref.cachedAt,cachedAt=_ref$cachedAt===undefined?0:_ref$cachedAt,_ref$cacheFor=_ref.cacheFor,cacheFor=_ref$cacheFor===undefined?0:_ref$cacheFor;return cachedAt+cacheFor<Date.now();};var isHardStorage=function isHardStorage(){var _ref2=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},_ref2$cacheFor=_ref2.cacheFor,cacheFor=_ref2$cacheFor===undefined?0:_ref2$cacheFor;return cacheFor>=1000*60*60*24;};var isSoftStorage=function isSoftStorage(){var _ref3=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},_ref3$cacheFor=_ref3.cacheFor,cacheFor=_ref3$cacheFor===undefined?0:_ref3$cacheFor;return cacheFor>=1000*60*60&&cacheFor<1000*60*60*24;};var filter=function filter(_ref4){var _ref4$meta=_ref4.meta;_ref4$meta=_ref4$meta===undefined?{}:_ref4$meta;var _ref4$meta$cacheFor=_ref4$meta.cacheFor,cacheFor=_ref4$meta$cacheFor===undefined?0:_ref4$meta$cacheFor;return!!cacheFor;};var filterFor=function filterFor(t){return function(){var _ref5=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},type=_ref5.type;return type===t;};};var filterMetaFor=function filterMetaFor(t){return function(){var _ref6=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},_ref6$meta=_ref6.meta;_ref6$meta=_ref6$meta===undefined?{}:_ref6$meta;var type=_ref6$meta.type;return type===t;};};var map=function map(){var _ref7=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},_ref7$meta$cacheFor=_ref7.meta.cacheFor,cacheFor=_ref7$meta$cacheFor===undefined?0:_ref7$meta$cacheFor;return cacheFor;};var reduce=function reduce(a){var _ref8=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{},type=_ref8.type,meta=_ref8.meta,_ref8$meta=_ref8.meta;_ref8$meta=_ref8$meta===undefined?{}:_ref8$meta;var _ref8$meta$cacheFor=_ref8$meta.cacheFor,cacheFor=_ref8$meta$cacheFor===undefined?0:_ref8$meta$cacheFor;var index=arguments[2];var array=arguments[3];return Math.min.apply(Math,_toConsumableArray(array.filter(filterFor(type)).map(map)))===cacheFor?a.concat(_extends({type:type},meta?{meta:meta}:{})):a;};var dedupe=function dedupe(a){var _ref9=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{},_ref9$meta=_ref9.meta;_ref9$meta=_ref9$meta===undefined?{}:_ref9$meta;var t=_ref9$meta.type,type=_ref9.type,meta=_ref9.meta;return a.map(map).includes(t)?a:a.concat(_extends({type:type},meta?{meta:meta}:{}));};var createIsHardStorage=function createIsHardStorage(meta){return isHardStorage(meta)?_extends({},meta,{isHardStorage:true}):_extends({},meta);};var createIsSoftStorage=function createIsSoftStorage(meta){return isSoftStorage(meta)?_extends({},meta,{isSoftStorage:true}):_extends({},meta);};var createAccessedAt=function createAccessedAt(_ref10){var _ref10$accessedAt=_ref10.accessedAt,accessedAt=_ref10$accessedAt===undefined?0:_ref10$accessedAt,meta=_objectWithoutProperties(_ref10,['accessedAt']);return _extends({},meta,accessedAt?{accessedAt:accessedAt}:{});};var createCachedAt=function createCachedAt(_ref11){var _ref11$cachedAt=_ref11.cachedAt,cachedAt=_ref11$cachedAt===undefined?0:_ref11$cachedAt,meta=_objectWithoutProperties(_ref11,['cachedAt']);return _extends({},meta,cachedAt?{cachedAt:cachedAt}:{});};var createCacheFor=function createCacheFor(_ref12){var _ref12$cacheFor=_ref12.cacheFor,cacheFor=_ref12$cacheFor===undefined?0:_ref12$cacheFor,meta=_objectWithoutProperties(_ref12,['cacheFor']);return _extends({},meta,cacheFor?{cacheFor:cacheFor}:{});};var createMeta=function createMeta(){var meta=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};return createIsHardStorage(createIsSoftStorage(createCacheFor(createCachedAt(createAccessedAt(meta)))));};var fetchMap=new Map();var storeMap=new Map();exports.default=function(array){if(Array.isArray(array)){array.filter(filter).reduce(reduce,[]).forEach(function(){var _ref13=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},type=_ref13.type,_ref13$meta=_ref13.meta;_ref13$meta=_ref13$meta===undefined?{}:_ref13$meta;var _ref13$meta$cacheFor=_ref13$meta.cacheFor,cacheFor=_ref13$meta$cacheFor===undefined?0:_ref13$meta$cacheFor;if(type){fetchMap.set(type,{type:type,cacheFor:cacheFor});}});array.reduce(dedupe,[]).forEach(function(){var _ref14=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},_ref14$meta=_ref14.meta;_ref14$meta=_ref14$meta===undefined?{}:_ref14$meta;var type=_ref14$meta.type,_ref14$meta$cacheFor=_ref14$meta.cacheFor,cacheFor=_ref14$meta$cacheFor===undefined?0:_ref14$meta$cacheFor,_ref14$meta2=_ref14.meta,meta=_ref14$meta2===undefined?{}:_ref14$meta2;if(type){storeMap.set(type,_extends({},meta,{cacheFor:cacheFor}));}});}return function(store){return function(next){return function(){var _ref15=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var type=_ref15.type,action=_objectWithoutProperties(_ref15,['type']);if(fetchMap.has(type)){var _store$getState=store.getState(),_store$getState$redux=_store$getState.reduxStorage;_store$getState$redux=_store$getState$redux===undefined?{}:_store$getState$redux;var _store$getState$redux2=_store$getState$redux[type];_store$getState$redux2=_store$getState$redux2===undefined?{}:_store$getState$redux2;var _store$getState$redux3=_store$getState$redux2.meta,meta=_store$getState$redux3===undefined?fetchMap.get(type):_store$getState$redux3;var _fetchMap$get=fetchMap.get(type),cacheFor=_fetchMap$get.cacheFor;var META=createMeta(_extends({},meta,{cacheFor:cacheFor}));if(isStale(META)){return next(_extends({},action,{type:type}));}else{array.filter(filterFor(type)).filter(filter).forEach(function(_ref16){var meta=_ref16.meta;var META=createMeta(_extends({},meta,{accessedAt:Date.now()}));store.dispatch((0,_actions.storageFetchAction)(META));});}}else{if(storeMap.has(type)){var _store$getState2=store.getState(),_store$getState2$redu=_store$getState2.reduxStorage;_store$getState2$redu=_store$getState2$redu===undefined?{}:_store$getState2$redu;var _store$getState2$redu2=_store$getState2$redu[type];_store$getState2$redu2=_store$getState2$redu2===undefined?{}:_store$getState2$redu2;var _store$getState2$redu3=_store$getState2$redu2.meta,_meta=_store$getState2$redu3===undefined?storeMap.get(type):_store$getState2$redu3;var cachedAt=Date.now();var _storeMap$get=storeMap.get(type),_storeMap$get$cacheFo=_storeMap$get.cacheFor,_cacheFor=_storeMap$get$cacheFo===undefined?0:_storeMap$get$cacheFo;if(_cacheFor){var _META=createMeta(_extends({},_meta,{cachedAt:cachedAt,cacheFor:_cacheFor}));store.dispatch((0,_actions.storageStoreAction)(_META,_extends({type:type},action)));array.filter(filterMetaFor(type)).filter(filter).forEach(function(_ref17){var type=_ref17.type;var _store$getState3=store.getState(),_store$getState3$redu=_store$getState3.reduxStorage;_store$getState3$redu=_store$getState3$redu===undefined?{}:_store$getState3$redu;var _store$getState3$redu2=_store$getState3$redu[type];_store$getState3$redu2=_store$getState3$redu2===undefined?{}:_store$getState3$redu2;var _store$getState3$redu3=_store$getState3$redu2.meta,meta=_store$getState3$redu3===undefined?fetchMap.get(type):_store$getState3$redu3;var _fetchMap$get2=fetchMap.get(type),cacheFor=_fetchMap$get2.cacheFor;var META=createMeta(_extends({},meta,{cachedAt:cachedAt,cacheFor:cacheFor}));store.dispatch((0,_actions.storageStoreAction)(META));});}else{array.filter(filterMetaFor(type)).forEach(function(_ref18){var type=_ref18.type;array.filter(filterFor(type)).filter(filter).forEach(function(_ref19,index,array){var type=_ref19.type,meta=_ref19.meta;var META=createMeta(_extends({},meta,{type:type}));store.dispatch((0,_actions.storageClearAction)(META));array.forEach(function(_ref20){var _ref20$meta=_ref20.meta;_ref20$meta=_ref20$meta===undefined?{}:_ref20$meta;var type=_ref20$meta.type,meta=_ref20.meta;var META=createMeta(_extends({},meta,{type:type}));store.dispatch((0,_actions.storageClearAction)(META));});});});}return next(_extends({},action,{type:type}));}else{return next(_extends({},action,{type:type}));}}};};};};