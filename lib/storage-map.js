'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key];}}}return target;};var _actions=require('./actions');function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++){arr2[i]=arr[i];}return arr2;}else{return Array.from(arr);}}function _objectWithoutProperties(obj,keys){var target={};for(var i in obj){if(keys.indexOf(i)>=0)continue;if(!Object.prototype.hasOwnProperty.call(obj,i))continue;target[i]=obj[i];}return target;}var isStale=function isStale(){var _ref=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},_ref$cachedAt=_ref.cachedAt,cachedAt=_ref$cachedAt===undefined?0:_ref$cachedAt,_ref$cacheFor=_ref.cacheFor,cacheFor=_ref$cacheFor===undefined?0:_ref$cacheFor;return cachedAt+cacheFor<Date.now();};var isHardStorage=function isHardStorage(){var _ref2=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},_ref2$cacheFor=_ref2.cacheFor,cacheFor=_ref2$cacheFor===undefined?0:_ref2$cacheFor;return cacheFor>=1000*60*60*24;};var isSoftStorage=function isSoftStorage(){var _ref3=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},_ref3$cacheFor=_ref3.cacheFor,cacheFor=_ref3$cacheFor===undefined?0:_ref3$cacheFor;return cacheFor>=1000*60*60&&cacheFor<1000*60*60*24;};var filterFor=function filterFor(t){return function(){var _ref4=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},type=_ref4.type;return type===t;};};var filterMetaFor=function filterMetaFor(t){return function(){var _ref5=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},_ref5$meta=_ref5.meta;_ref5$meta=_ref5$meta===undefined?{}:_ref5$meta;var type=_ref5$meta.type;return type===t;};};var mapType=function mapType(){var _ref6=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},type=_ref6.type;return type;};var mapMetaType=function mapMetaType(){var _ref7=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},_ref7$meta=_ref7.meta;_ref7$meta=_ref7$meta===undefined?{}:_ref7$meta;var type=_ref7$meta.type;return type;};var mapCacheFor=function mapCacheFor(){var _ref8=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},_ref8$meta=_ref8.meta;_ref8$meta=_ref8$meta===undefined?{}:_ref8$meta;var _ref8$meta$cacheFor=_ref8$meta.cacheFor,cacheFor=_ref8$meta$cacheFor===undefined?0:_ref8$meta$cacheFor;return cacheFor;};var mapCachedAt=function mapCachedAt(){var _ref9=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},_ref9$meta=_ref9.meta;_ref9$meta=_ref9$meta===undefined?{}:_ref9$meta;var _ref9$meta$cachedAt=_ref9$meta.cachedAt,cachedAt=_ref9$meta$cachedAt===undefined?0:_ref9$meta$cachedAt;return cachedAt;};var createIsHardStorage=function createIsHardStorage(meta){return isHardStorage(meta)?_extends({},meta,{isHardStorage:true}):_extends({},meta);};var createIsSoftStorage=function createIsSoftStorage(meta){return isSoftStorage(meta)?_extends({},meta,{isSoftStorage:true}):_extends({},meta);};var createAccessedAt=function createAccessedAt(_ref10){var _ref10$accessedAt=_ref10.accessedAt,accessedAt=_ref10$accessedAt===undefined?0:_ref10$accessedAt,meta=_objectWithoutProperties(_ref10,['accessedAt']);return _extends({},meta,accessedAt?{accessedAt:accessedAt}:{});};var createCachedAt=function createCachedAt(_ref11){var _ref11$cachedAt=_ref11.cachedAt,cachedAt=_ref11$cachedAt===undefined?0:_ref11$cachedAt,meta=_objectWithoutProperties(_ref11,['cachedAt']);return _extends({},meta,cachedAt?{cachedAt:cachedAt}:{});};var createCacheFor=function createCacheFor(_ref12){var _ref12$cacheFor=_ref12.cacheFor,cacheFor=_ref12$cacheFor===undefined?0:_ref12$cacheFor,meta=_objectWithoutProperties(_ref12,['cacheFor']);return _extends({},meta,cacheFor?{cacheFor:cacheFor}:{});};var createMeta=function createMeta(){var meta=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};return createIsHardStorage(createIsSoftStorage(createCacheFor(createCachedAt(createAccessedAt(meta)))));};var fetchMap=new Map();var storeMap=new Map();var fetchMetaMap=new Map();var storeMetaMap=new Map();var clearMap=new Map();var hasCacheFor=function hasCacheFor(value){return!isNaN(value)&&!!value;};var notCacheFor=function notCacheFor(value){return isNaN(value)||!value;};var fetchFilter=function fetchFilter(){var _ref13=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},_ref13$meta=_ref13.meta;_ref13$meta=_ref13$meta===undefined?{}:_ref13$meta;var type=_ref13$meta.type,_ref13$meta$cacheFor=_ref13$meta.cacheFor,cacheFor=_ref13$meta$cacheFor===undefined?0:_ref13$meta$cacheFor;return hasCacheFor(cacheFor);};var storeFilter=function storeFilter(){var _ref14=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},_ref14$meta=_ref14.meta;_ref14$meta=_ref14$meta===undefined?{}:_ref14$meta;var type=_ref14$meta.type,_ref14$meta$cacheFor=_ref14$meta.cacheFor,cacheFor=_ref14$meta$cacheFor===undefined?0:_ref14$meta$cacheFor;return hasCacheFor(cacheFor);};var clearFilter=function clearFilter(){var _ref15=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},_ref15$meta=_ref15.meta;_ref15$meta=_ref15$meta===undefined?{}:_ref15$meta;var type=_ref15$meta.type,_ref15$meta$cacheFor=_ref15$meta.cacheFor,cacheFor=_ref15$meta$cacheFor===undefined?0:_ref15$meta$cacheFor;return notCacheFor(cacheFor);};var min=function min(values){return Math.min.apply(Math,_toConsumableArray(values));};var max=function max(values){return Math.max.apply(Math,_toConsumableArray(values));};var fetchReduce=function fetchReduce(){var a=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];var _ref16=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{},type=_ref16.type,meta=_ref16.meta,_ref16$meta=_ref16.meta;_ref16$meta=_ref16$meta===undefined?{}:_ref16$meta;var _ref16$meta$cacheFor=_ref16$meta.cacheFor,cacheFor=_ref16$meta$cacheFor===undefined?0:_ref16$meta$cacheFor;var i=arguments[2];var array=arguments[3];return a.map(mapType).includes(type)?a:min(array.filter(filterFor(type)).map(mapCacheFor))!==cacheFor?a:a.concat(_extends({type:type},meta?{meta:meta}:{}));};var storeReduce=function storeReduce(){var a=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];var _ref17=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{},type=_ref17.type,meta=_ref17.meta,_ref17$meta=_ref17.meta;_ref17$meta=_ref17$meta===undefined?{}:_ref17$meta;var _ref17$meta$cacheFor=_ref17$meta.cacheFor,cacheFor=_ref17$meta$cacheFor===undefined?0:_ref17$meta$cacheFor;var i=arguments[2];var array=arguments[3];return a.map(mapType).includes(type)?a:min(array.filter(filterFor(type)).map(mapCacheFor))!==cacheFor?a:a.concat(_extends({type:type},meta?{meta:meta}:{}));};var clearReduce=function clearReduce(){var a=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];var _ref18=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{},type=_ref18.type,meta=_ref18.meta,_ref18$meta=_ref18.meta;_ref18$meta=_ref18$meta===undefined?{}:_ref18$meta;var _ref18$meta$cacheFor=_ref18$meta.cacheFor,cacheFor=_ref18$meta$cacheFor===undefined?0:_ref18$meta$cacheFor;var i=arguments[2];var array=arguments[3];return a.map(mapType).includes(type)?a:min(array.filter(filterFor(type)).map(mapCacheFor))!==cacheFor?a:a.concat(_extends({type:type},meta?{meta:meta}:{}));};var fetchDedupe=function fetchDedupe(){var a=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];var _ref19=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{},type=_ref19.type,meta=_ref19.meta;return a.map(mapType).includes(type)?a:a.concat(_extends({type:type},meta?{meta:meta}:{}));};var storeDedupe=function storeDedupe(){var a=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];var _ref20=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{},type=_ref20.type,meta=_ref20.meta,_ref20$meta=_ref20.meta;_ref20$meta=_ref20$meta===undefined?{}:_ref20$meta;var t=_ref20$meta.type;return a.map(mapMetaType).includes(t)?a:a.concat(_extends({type:type},meta?{meta:meta}:{}));};var clearDedupe=function clearDedupe(){var a=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];var _ref21=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{},type=_ref21.type,meta=_ref21.meta,_ref21$meta=_ref21.meta;_ref21$meta=_ref21$meta===undefined?{}:_ref21$meta;var t=_ref21$meta.type;return a.map(mapMetaType).includes(t)?a:a.concat(_extends({type:type},meta?{meta:meta}:{}));};var hardStorageFilter=function hardStorageFilter(_ref22){var meta=_ref22.meta;return isHardStorage(meta);};var softStorageFilter=function softStorageFilter(_ref23){var meta=_ref23.meta;return isSoftStorage(meta);};var storageFilter=function storageFilter(_ref24){var meta=_ref24.meta;return!(isHardStorage(meta)||isSoftStorage(meta));};exports.default=function(array){if(Array.isArray(array)){var fetchArray=array.filter(fetchFilter);var storeArray=array.filter(storeFilter);var clearArray=array.filter(clearFilter);fetchArray.filter(hardStorageFilter).reduce(fetchReduce,[]).forEach(function(){var _ref25=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},type=_ref25.type,_ref25$meta=_ref25.meta;_ref25$meta=_ref25$meta===undefined?{}:_ref25$meta;var cacheFor=_ref25$meta.cacheFor;fetchMap.set(type,{type:type,cacheFor:cacheFor});});fetchArray.filter(softStorageFilter).reduce(fetchReduce,[]).forEach(function(){var _ref26=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},type=_ref26.type,_ref26$meta=_ref26.meta;_ref26$meta=_ref26$meta===undefined?{}:_ref26$meta;var cacheFor=_ref26$meta.cacheFor;fetchMap.set(type,{type:type,cacheFor:cacheFor});});fetchArray.filter(storageFilter).reduce(fetchReduce,[]).forEach(function(){var _ref27=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},type=_ref27.type,_ref27$meta=_ref27.meta;_ref27$meta=_ref27$meta===undefined?{}:_ref27$meta;var cacheFor=_ref27$meta.cacheFor;fetchMap.set(type,{type:type,cacheFor:cacheFor});});storeArray.filter(hardStorageFilter).filter(function(_ref28){var type=_ref28.meta.type;return!fetchMap.has(type);}).reduce(storeReduce,[]).forEach(function(){var _ref29=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var type=_ref29.type,_ref29$meta=_ref29.meta;_ref29$meta=_ref29$meta===undefined?{}:_ref29$meta;var TYPE=_ref29$meta.type,meta=_objectWithoutProperties(_ref29$meta,['type']);var storeSet=storeMap.get(TYPE)||new Set();storeMap.set(TYPE,storeSet.add(_extends({},meta,{type:type})));});storeArray.filter(softStorageFilter).filter(function(_ref30){var type=_ref30.meta.type;return!fetchMap.has(type);}).reduce(storeReduce,[]).forEach(function(){var _ref31=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var type=_ref31.type,_ref31$meta=_ref31.meta;_ref31$meta=_ref31$meta===undefined?{}:_ref31$meta;var TYPE=_ref31$meta.type,meta=_objectWithoutProperties(_ref31$meta,['type']);var storeSet=storeMap.get(TYPE)||new Set();storeMap.set(TYPE,storeSet.add(_extends({},meta,{type:type})));});storeArray.filter(storageFilter).filter(function(_ref32){var type=_ref32.meta.type;return!fetchMap.has(type);}).reduce(storeReduce,[]).forEach(function(){var _ref33=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var type=_ref33.type,_ref33$meta=_ref33.meta;_ref33$meta=_ref33$meta===undefined?{}:_ref33$meta;var TYPE=_ref33$meta.type,meta=_objectWithoutProperties(_ref33$meta,['type']);var storeSet=storeMap.get(TYPE)||new Set();storeMap.set(TYPE,storeSet.add(_extends({},meta,{type:type})));});storeArray.filter(hardStorageFilter).reduce(storeReduce,[]).reduce(storeDedupe,[]).forEach(function(_ref34){var type=_ref34.type,_ref34$meta=_ref34.meta,cacheFor=_ref34$meta.cacheFor,meta=_objectWithoutProperties(_ref34$meta,['cacheFor']);var fetchMetaSet=fetchMetaMap.get(type)||new Set();fetchMetaMap.set(type,fetchMetaSet.add(_extends({},meta,{cacheFor:cacheFor})));});storeArray.filter(softStorageFilter).reduce(storeReduce,[]).reduce(storeDedupe,[]).forEach(function(_ref35){var type=_ref35.type,_ref35$meta=_ref35.meta,cacheFor=_ref35$meta.cacheFor,meta=_objectWithoutProperties(_ref35$meta,['cacheFor']);var fetchMetaSet=fetchMetaMap.get(type)||new Set();fetchMetaMap.set(type,fetchMetaSet.add(_extends({},meta,{cacheFor:cacheFor})));});storeArray.filter(storageFilter).reduce(storeReduce,[]).reduce(storeDedupe,[]).forEach(function(_ref36){var type=_ref36.type,_ref36$meta=_ref36.meta,cacheFor=_ref36$meta.cacheFor,meta=_objectWithoutProperties(_ref36$meta,['cacheFor']);var fetchMetaSet=fetchMetaMap.get(type)||new Set();fetchMetaMap.set(type,fetchMetaSet.add(_extends({},meta,{cacheFor:cacheFor})));});storeArray.filter(hardStorageFilter).reduce(storeReduce,[]).reduce(storeDedupe,[]).forEach(function(_ref37){var _ref37$meta=_ref37.meta,type=_ref37$meta.type,cacheFor=_ref37$meta.cacheFor;var storeMetaSet=storeMetaMap.get(type)||new Set();storeMetaMap.set(type,storeMetaSet.add({type:type,cacheFor:cacheFor}));});storeArray.filter(softStorageFilter).reduce(storeReduce,[]).reduce(storeDedupe,[]).forEach(function(_ref38){var _ref38$meta=_ref38.meta,type=_ref38$meta.type,cacheFor=_ref38$meta.cacheFor;var storeMetaSet=storeMetaMap.get(type)||new Set();storeMetaMap.set(type,storeMetaSet.add({type:type,cacheFor:cacheFor}));});storeArray.filter(storageFilter).reduce(storeReduce,[]).reduce(storeDedupe,[]).forEach(function(_ref39){var _ref39$meta=_ref39.meta,type=_ref39$meta.type,cacheFor=_ref39$meta.cacheFor;var storeMetaSet=storeMetaMap.get(type)||new Set();storeMetaMap.set(type,storeMetaSet.add({type:type,cacheFor:cacheFor}));});clearArray.filter(function(_ref40){var type=_ref40.meta.type;return!(fetchMap.has(type)||storeMap.has(type));}).reduce(clearReduce,[]).forEach(function(){var _ref41=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var type=_ref41.type,_ref41$meta=_ref41.meta;_ref41$meta=_ref41$meta===undefined?{}:_ref41$meta;var TYPE=_ref41$meta.type,cacheFor=_ref41$meta.cacheFor,meta=_objectWithoutProperties(_ref41$meta,['type','cacheFor']);var clearSet=clearMap.get(TYPE)||new Set();clearMap.set(TYPE,clearSet.add(_extends({},meta,{type:type},cacheFor?{cacheFor:cacheFor}:{},{isNaN:isNaN(cacheFor)})));});}return function(store){return function(next){return function(){var _ref42=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var type=_ref42.type,action=_objectWithoutProperties(_ref42,['type']);if(fetchMap.has(type)){var defaultMeta=fetchMap.get(type);var _store$getState=store.getState(),_store$getState$redux=_store$getState.reduxStorage;_store$getState$redux=_store$getState$redux===undefined?{}:_store$getState$redux;var _store$getState$redux2=_store$getState$redux[type];_store$getState$redux2=_store$getState$redux2===undefined?{}:_store$getState$redux2;var _store$getState$redux3=_store$getState$redux2.meta,meta=_store$getState$redux3===undefined?defaultMeta:_store$getState$redux3;var cacheFor=defaultMeta.cacheFor;var META=createMeta(_extends({},meta,{cacheFor:cacheFor}));if(isStale(META)){return next(_extends({},action,{type:type}));}else{var accessedAt=Date.now();if(fetchMetaMap.has(type)){var fetchMetaSet=fetchMetaMap.get(type);fetchMetaSet.forEach(function(_ref43){var type=_ref43.type,cacheFor=_ref43.cacheFor;var META=createMeta({type:type,cacheFor:cacheFor,accessedAt:accessedAt});store.dispatch((0,_actions.storageFetchAction)(META));});}var _META=createMeta({type:type,cacheFor:cacheFor,accessedAt:accessedAt});store.dispatch((0,_actions.storageFetchAction)(_META,_extends({},action,{type:type})));return next(_extends({},action,{type:type}));}}else{if(storeMap.has(type)){var cachedAt=Date.now();if(storeMetaMap.has(type)){var storeMetaSet=storeMetaMap.get(type);storeMetaSet.forEach(function(_ref44){var type=_ref44.type,cacheFor=_ref44.cacheFor;var META=createMeta({type:type,cacheFor:cacheFor,cachedAt:cachedAt});store.dispatch((0,_actions.storageStoreAction)(META,_extends({},action,{type:type})));});}var storeSet=storeMap.get(type);storeSet.forEach(function(_ref45){var type=_ref45.type,cacheFor=_ref45.cacheFor;var META=createMeta({type:type,cacheFor:cacheFor,cachedAt:cachedAt});store.dispatch((0,_actions.storageStoreAction)(META));});return next(_extends({},action,{type:type}));}else{if(clearMap.has(type)){var clearSet=clearMap.get(type);clearSet.forEach(function(_ref46){var type=_ref46.type;if(fetchMetaMap.has(type)){var _fetchMetaSet=fetchMetaMap.get(type);_fetchMetaSet.forEach(function(_ref47){var type=_ref47.type;if(storeMap.has(type)){if(storeMetaMap.has(type)){var _storeMetaSet=storeMetaMap.get(type);_storeMetaSet.forEach(function(_ref48){var type=_ref48.type,cacheFor=_ref48.cacheFor;var META=createMeta({type:type,cacheFor:cacheFor});store.dispatch((0,_actions.storageClearAction)(META,_extends({},action,{type:type})));});}var _storeSet=storeMap.get(type);_storeSet.forEach(function(_ref49){var type=_ref49.type,cacheFor=_ref49.cacheFor;var META=createMeta({type:type,cacheFor:cacheFor});store.dispatch((0,_actions.storageClearAction)(META));});}});}});return next(_extends({},action,{type:type}));}}}return next(_extends({},action,{type:type}));};};};};