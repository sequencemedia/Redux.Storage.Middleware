"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.default=exports.mergeData=exports.mergeMeta=exports.transformMeta=exports.createMeta=exports.createAccessedAt=exports.createCacheFor=exports.createCachedAt=exports.createIsSoftStorage=exports.createIsHardStorage=exports.createType=exports.fromStringToObject=exports.fromObjectToString=void 0;var _actions=require("./actions");var _hardStorage=_interopRequireDefault(require("./components/storage/hard-storage"));var _softStorage=_interopRequireDefault(require("./components/storage/soft-storage"));function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};var ownKeys=Object.keys(source);if(typeof Object.getOwnPropertySymbols==='function'){ownKeys=ownKeys.concat(Object.getOwnPropertySymbols(source).filter(function(sym){return Object.getOwnPropertyDescriptor(source,sym).enumerable;}));}ownKeys.forEach(function(key){_defineProperty(target,key,source[key]);});}return target;}function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else{obj[key]=value;}return obj;}function _objectWithoutProperties(source,excluded){if(source==null)return{};var target=_objectWithoutPropertiesLoose(source,excluded);var key,i;if(Object.getOwnPropertySymbols){var sourceSymbolKeys=Object.getOwnPropertySymbols(source);for(i=0;i<sourceSymbolKeys.length;i++){key=sourceSymbolKeys[i];if(excluded.indexOf(key)>=0)continue;if(!Object.prototype.propertyIsEnumerable.call(source,key))continue;target[key]=source[key];}}return target;}function _objectWithoutPropertiesLoose(source,excluded){if(source==null)return{};var target={};var sourceKeys=Object.keys(source);var key,i;for(i=0;i<sourceKeys.length;i++){key=sourceKeys[i];if(excluded.indexOf(key)>=0)continue;target[key]=source[key];}return target;}var hardStorage=(0,_hardStorage.default)();var softStorage=(0,_softStorage.default)();var fromObjectToString=function fromObjectToString(object){return JSON.stringify(object);};exports.fromObjectToString=fromObjectToString;var fromStringToObject=function fromStringToObject(string){return JSON.parse(string);};exports.fromStringToObject=fromStringToObject;var createType=function createType(_ref){var type=_ref.type,meta=_objectWithoutProperties(_ref,["type"]);return _objectSpread({},meta,type?{type:type}:{});};exports.createType=createType;var createIsHardStorage=function createIsHardStorage(_ref2){var _ref2$isHardStorage=_ref2.isHardStorage,isHardStorage=_ref2$isHardStorage===void 0?false:_ref2$isHardStorage,meta=_objectWithoutProperties(_ref2,["isHardStorage"]);return _objectSpread({},meta,isHardStorage?{isHardStorage:isHardStorage}:{});};exports.createIsHardStorage=createIsHardStorage;var createIsSoftStorage=function createIsSoftStorage(_ref3){var _ref3$isSoftStorage=_ref3.isSoftStorage,isSoftStorage=_ref3$isSoftStorage===void 0?false:_ref3$isSoftStorage,meta=_objectWithoutProperties(_ref3,["isSoftStorage"]);return _objectSpread({},meta,isSoftStorage?{isSoftStorage:isSoftStorage}:{});};exports.createIsSoftStorage=createIsSoftStorage;var createCachedAt=function createCachedAt(_ref4){var _ref4$cachedAt=_ref4.cachedAt,cachedAt=_ref4$cachedAt===void 0?0:_ref4$cachedAt,meta=_objectWithoutProperties(_ref4,["cachedAt"]);return _objectSpread({},meta,cachedAt?{cachedAt:cachedAt}:{});};exports.createCachedAt=createCachedAt;var createCacheFor=function createCacheFor(_ref5){var _ref5$cacheFor=_ref5.cacheFor,cacheFor=_ref5$cacheFor===void 0?0:_ref5$cacheFor,meta=_objectWithoutProperties(_ref5,["cacheFor"]);return _objectSpread({},meta,cacheFor?{cacheFor:cacheFor}:{});};exports.createCacheFor=createCacheFor;var createAccessedAt=function createAccessedAt(_ref6){var _ref6$accessedAt=_ref6.accessedAt,accessedAt=_ref6$accessedAt===void 0?false:_ref6$accessedAt,meta=_objectWithoutProperties(_ref6,["accessedAt"]);return _objectSpread({},meta,accessedAt?{accessedAt:accessedAt}:{});};exports.createAccessedAt=createAccessedAt;var createMeta=function createMeta(){var meta=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};return createType(createIsHardStorage(createIsSoftStorage(meta)));};exports.createMeta=createMeta;var transformMeta=function transformMeta(){var _ref7=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},_ref7$cachedAt=_ref7.cachedAt,cachedAt=_ref7$cachedAt===void 0?0:_ref7$cachedAt,_ref7$cacheFor=_ref7.cacheFor,cacheFor=_ref7$cacheFor===void 0?0:_ref7$cacheFor,_ref7$accessedAt=_ref7.accessedAt,accessedAt=_ref7$accessedAt===void 0?0:_ref7$accessedAt;return createCachedAt(createCacheFor(createAccessedAt({cachedAt:cachedAt,cacheFor:cacheFor,accessedAt:accessedAt})));};exports.transformMeta=transformMeta;var mergeMeta=function mergeMeta(alpha,omega){return{meta:_objectSpread({},alpha||{},omega||{})};};exports.mergeMeta=mergeMeta;var mergeData=function mergeData(alpha,omega){return _objectSpread({},alpha?{data:_objectSpread({},alpha,omega||{})}:omega?{data:omega}:{});};exports.mergeData=mergeData;function get(store,_ref8){var _ref8$meta=_ref8.meta;_ref8$meta=_ref8$meta===void 0?{}:_ref8$meta;var _ref8$meta$isHardStor=_ref8$meta.isHardStorage,isHardStorage=_ref8$meta$isHardStor===void 0?false:_ref8$meta$isHardStor,_ref8$meta$isSoftStor=_ref8$meta.isSoftStorage,isSoftStorage=_ref8$meta$isSoftStor===void 0?false:_ref8$meta$isSoftStor,type=_ref8$meta.type;if(isHardStorage){var _getStateForType=getStateForType(type,getReduxStorage(store.getState())),data=_getStateForType.data;return data;}else{if(isSoftStorage){var _getStateForType2=getStateForType(type,getReduxStorage(store.getState())),_data=_getStateForType2.data;return _data;}else{var _getStateForType3=getStateForType(type,getReduxStorage(store.getState())),_data2=_getStateForType3.data;return _data2;}}}var getReduxStorage=function getReduxStorage(){var _ref9=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},_ref9$reduxStorage=_ref9.reduxStorage,reduxStorage=_ref9$reduxStorage===void 0?{}:_ref9$reduxStorage;return reduxStorage;};var getStateForType=function getStateForType(type){var _ref10=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{},_ref10$type=_ref10[type],state=_ref10$type===void 0?{}:_ref10$type;return state;};function put(store,_ref11){var META=_ref11.meta,_ref11$meta=_ref11.meta;_ref11$meta=_ref11$meta===void 0?{}:_ref11$meta;var _ref11$meta$isHardSto=_ref11$meta.isHardStorage,isHardStorage=_ref11$meta$isHardSto===void 0?false:_ref11$meta$isHardSto,_ref11$meta$isSoftSto=_ref11$meta.isSoftStorage,isSoftStorage=_ref11$meta$isSoftSto===void 0?false:_ref11$meta$isSoftSto,type=_ref11$meta.type,meta=_objectWithoutProperties(_ref11$meta,["isHardStorage","isSoftStorage","type"]),data=_ref11.data;if(isHardStorage){var _getStateForType4=getStateForType(type,getReduxStorage(store.getState())),_getStateForType4$met=_getStateForType4.meta,stateMeta=_getStateForType4$met===void 0?{}:_getStateForType4$met,stateData=_getStateForType4.data;var ITEM=fromObjectToString(_objectSpread({meta:transformMeta(_objectSpread({},stateMeta,meta))},data?{data:data}:_objectSpread({},stateData?{data:stateData}:{})));hardStorage.setItem(type,ITEM);}else{if(isSoftStorage){var _getStateForType5=getStateForType(type,getReduxStorage(store.getState())),_getStateForType5$met=_getStateForType5.meta,_stateMeta=_getStateForType5$met===void 0?{}:_getStateForType5$met,_stateData=_getStateForType5.data;var _ITEM=fromObjectToString(_objectSpread({meta:transformMeta(_objectSpread({},_stateMeta,meta))},data?{data:data}:_objectSpread({},_stateData?{data:_stateData}:{})));softStorage.setItem(type,_ITEM);}}}function storageFetch(store,_ref12){var _ref12$meta=_ref12.meta;_ref12$meta=_ref12$meta===void 0?{}:_ref12$meta;var _ref12$meta$isHardSto=_ref12$meta.isHardStorage,isHardStorage=_ref12$meta$isHardSto===void 0?false:_ref12$meta$isHardSto,_ref12$meta$isSoftSto=_ref12$meta.isSoftStorage,isSoftStorage=_ref12$meta$isSoftSto===void 0?false:_ref12$meta$isSoftSto,type=_ref12$meta.type,meta=_objectWithoutProperties(_ref12$meta,["isHardStorage","isSoftStorage","type"]),data=_ref12.data;if(isHardStorage){var _getStateForType6=getStateForType(type,getReduxStorage(store.getState())),_getStateForType6$met=_getStateForType6.meta,stateMeta=_getStateForType6$met===void 0?{}:_getStateForType6$met,stateData=_getStateForType6.data;var ITEM=fromObjectToString(_objectSpread({meta:transformMeta(_objectSpread({},stateMeta,meta))},stateData?{data:_objectSpread({},stateData,data||{})}:data?{data:data}:{}));hardStorage.setItem(type,ITEM);}else{if(isSoftStorage){var _getStateForType7=getStateForType(type,getReduxStorage(store.getState())),_getStateForType7$met=_getStateForType7.meta,_stateMeta2=_getStateForType7$met===void 0?{}:_getStateForType7$met,_stateData2=_getStateForType7.data;var _ITEM2=fromObjectToString(_objectSpread({meta:transformMeta(_objectSpread({},_stateMeta2,meta))},_stateData2?{data:_objectSpread({},_stateData2,data||{})}:data?{data:data}:{}));softStorage.setItem(type,_ITEM2);}}}function storageStore(store,_ref13){var _ref13$meta=_ref13.meta;_ref13$meta=_ref13$meta===void 0?{}:_ref13$meta;var _ref13$meta$isHardSto=_ref13$meta.isHardStorage,isHardStorage=_ref13$meta$isHardSto===void 0?false:_ref13$meta$isHardSto,_ref13$meta$isSoftSto=_ref13$meta.isSoftStorage,isSoftStorage=_ref13$meta$isSoftSto===void 0?false:_ref13$meta$isSoftSto,type=_ref13$meta.type,meta=_objectWithoutProperties(_ref13$meta,["isHardStorage","isSoftStorage","type"]),data=_ref13.data;if(isHardStorage){var _getStateForType8=getStateForType(type,getReduxStorage(store.getState())),_getStateForType8$met=_getStateForType8.meta,stateMeta=_getStateForType8$met===void 0?{}:_getStateForType8$met,stateData=_getStateForType8.data;var ITEM=fromObjectToString(_objectSpread({meta:transformMeta(_objectSpread({},stateMeta,meta))},stateData?{data:_objectSpread({},stateData,data||{})}:data?{data:data}:{}));hardStorage.setItem(type,ITEM);}else{if(isSoftStorage){var _getStateForType9=getStateForType(type,getReduxStorage(store.getState())),_getStateForType9$met=_getStateForType9.meta,_stateMeta3=_getStateForType9$met===void 0?{}:_getStateForType9$met,_stateData3=_getStateForType9.data;var _ITEM3=fromObjectToString(_objectSpread({meta:transformMeta(_objectSpread({},_stateMeta3,meta))},_stateData3?{data:_objectSpread({},_stateData3,data||{})}:data?{data:data}:{}));softStorage.setItem(type,_ITEM3);}}}function storageClear(store,_ref14){var _ref14$meta=_ref14.meta;_ref14$meta=_ref14$meta===void 0?{}:_ref14$meta;var _ref14$meta$isHardSto=_ref14$meta.isHardStorage,isHardStorage=_ref14$meta$isHardSto===void 0?false:_ref14$meta$isHardSto,_ref14$meta$isSoftSto=_ref14$meta.isSoftStorage,isSoftStorage=_ref14$meta$isSoftSto===void 0?false:_ref14$meta$isSoftSto,type=_ref14$meta.type,meta=_objectWithoutProperties(_ref14$meta,["isHardStorage","isSoftStorage","type"]),action=_objectWithoutProperties(_ref14,["meta"]);if(isHardStorage){hardStorage.removeItem(type);}else{if(isSoftStorage){softStorage.removeItem(type);}}}var _default=function _default(store){return function(next){return function(action){var type=action.type;switch(type){case _actions.STORAGE_COMPARE:{var _action$meta=action.meta,cacheFor=_action$meta.cacheFor,cachedAt=_action$meta.cachedAt,comparator=_action$meta.comparator,then=_action$meta.then,ACTION=action.data;return comparator(get(store,action)||{},ACTION,_objectSpread({cacheFor:cacheFor},cachedAt?{cachedAt:new Date(cachedAt)}:{}))?next(put(store,action)||ACTION):then(ACTION);}case _actions.STORAGE_FETCH:storageFetch(store,action);return next(action);case _actions.STORAGE_STORE:storageStore(store,action);return next(action);case _actions.STORAGE_CLEAR:storageClear(store,action);return next(action);default:return next(action);}};};};exports.default=_default;