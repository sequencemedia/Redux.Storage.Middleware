'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key];}}}return target;};var _actions=require('./actions');var _hardStorage=require('./components/storage/hard-storage');var _hardStorage2=_interopRequireDefault(_hardStorage);var _softStorage=require('./components/storage/soft-storage');var _softStorage2=_interopRequireDefault(_softStorage);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _objectWithoutProperties(obj,keys){var target={};for(var i in obj){if(keys.indexOf(i)>=0)continue;if(!Object.prototype.hasOwnProperty.call(obj,i))continue;target[i]=obj[i];}return target;}var hardStorage=(0,_hardStorage2.default)();var softStorage=(0,_softStorage2.default)();var fromObjectToString=function fromObjectToString(object){return JSON.stringify(object);};var fromStringToObject=function fromStringToObject(string){return JSON.parse(string);};var createType=function createType(_ref){var type=_ref.type,meta=_objectWithoutProperties(_ref,['type']);return _extends({},meta,type?{type:type}:{});};var createIsHardStorage=function createIsHardStorage(_ref2){var _ref2$isHardStorage=_ref2.isHardStorage,isHardStorage=_ref2$isHardStorage===undefined?false:_ref2$isHardStorage,meta=_objectWithoutProperties(_ref2,['isHardStorage']);return _extends({},meta,isHardStorage?{isHardStorage:isHardStorage}:{});};var createIsSoftStorage=function createIsSoftStorage(_ref3){var _ref3$isSoftStorage=_ref3.isSoftStorage,isSoftStorage=_ref3$isSoftStorage===undefined?false:_ref3$isSoftStorage,meta=_objectWithoutProperties(_ref3,['isSoftStorage']);return _extends({},meta,isSoftStorage?{isSoftStorage:isSoftStorage}:{});};var createMeta=function createMeta(){var meta=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};return createType(createIsHardStorage(createIsSoftStorage(meta)));};function get(store,_ref4){var _ref4$meta=_ref4.meta;_ref4$meta=_ref4$meta===undefined?{}:_ref4$meta;var _ref4$meta$isHardStor=_ref4$meta.isHardStorage,isHardStorage=_ref4$meta$isHardStor===undefined?false:_ref4$meta$isHardStor,_ref4$meta$isSoftStor=_ref4$meta.isSoftStorage,isSoftStorage=_ref4$meta$isSoftStor===undefined?false:_ref4$meta$isSoftStor,type=_ref4$meta.type;if(isHardStorage){var item=hardStorage.getItem(type);var _ref5=fromStringToObject(item)||{},data=_ref5.data;return data;}else{if(isSoftStorage){var _item=softStorage.getItem(type);var _ref6=fromStringToObject(_item)||{},_data=_ref6.data;return _data;}else{var _store$getState=store.getState(),_store$getState$redux=_store$getState.reduxStorage;_store$getState$redux=_store$getState$redux===undefined?{}:_store$getState$redux;var _store$getState$redux2=_store$getState$redux[type];_store$getState$redux2=_store$getState$redux2===undefined?{}:_store$getState$redux2;var _data2=_store$getState$redux2.data;return _data2;}}}function put(store,_ref7){var META=_ref7.meta,_ref7$meta=_ref7.meta;_ref7$meta=_ref7$meta===undefined?{}:_ref7$meta;var _ref7$meta$isHardStor=_ref7$meta.isHardStorage,isHardStorage=_ref7$meta$isHardStor===undefined?false:_ref7$meta$isHardStor,_ref7$meta$isSoftStor=_ref7$meta.isSoftStorage,isSoftStorage=_ref7$meta$isSoftStor===undefined?false:_ref7$meta$isSoftStor,type=_ref7$meta.type,meta=_objectWithoutProperties(_ref7$meta,['isHardStorage','isSoftStorage','type']),data=_ref7.data;if(isHardStorage){var item=hardStorage.getItem(type);var _ref8=fromStringToObject(item)||{},_ref8$meta=_ref8.meta,storageMeta=_ref8$meta===undefined?{}:_ref8$meta,storageData=_ref8.data;var ITEM=fromObjectToString(_extends({meta:createMeta(_extends({},storageMeta,meta))},data?{data:data}:_extends({},storageData?{data:storageData}:{})));hardStorage.setItem(type,ITEM);}else{if(isSoftStorage){var _item2=softStorage.getItem(type);var _ref9=fromStringToObject(_item2)||{},_ref9$meta=_ref9.meta,_storageMeta=_ref9$meta===undefined?{}:_ref9$meta,_storageData=_ref9.data;var _ITEM=fromObjectToString(_extends({meta:createMeta(_extends({},_storageMeta,meta))},data?{data:data}:_extends({},_storageData?{data:_storageData}:{})));softStorage.setItem(type,_ITEM);}}}function storageFetch(store,_ref10){var _ref10$meta=_ref10.meta;_ref10$meta=_ref10$meta===undefined?{}:_ref10$meta;var _ref10$meta$isHardSto=_ref10$meta.isHardStorage,isHardStorage=_ref10$meta$isHardSto===undefined?false:_ref10$meta$isHardSto,_ref10$meta$isSoftSto=_ref10$meta.isSoftStorage,isSoftStorage=_ref10$meta$isSoftSto===undefined?false:_ref10$meta$isSoftSto,type=_ref10$meta.type,meta=_objectWithoutProperties(_ref10$meta,['isHardStorage','isSoftStorage','type']),data=_ref10.data,action=_objectWithoutProperties(_ref10,['meta','data']);if(isHardStorage){var item=hardStorage.getItem(type);var _ref11=fromStringToObject(item)||{},_ref11$meta=_ref11.meta,storageMeta=_ref11$meta===undefined?{}:_ref11$meta,storageData=_ref11.data;var ITEM=fromObjectToString(_extends({meta:createMeta(_extends({},storageMeta,meta))},data?{data:data}:_extends({},storageData?{data:storageData}:{})));hardStorage.setItem(type,ITEM);if(storageData)store.dispatch(storageData);}else{if(isSoftStorage){var _item3=softStorage.getItem(type);var _ref12=fromStringToObject(_item3)||{},_ref12$meta=_ref12.meta,_storageMeta2=_ref12$meta===undefined?{}:_ref12$meta,_storageData2=_ref12.data;var _ITEM2=fromObjectToString(_extends({meta:createMeta(_extends({},_storageMeta2,meta))},data?{data:data}:_extends({},_storageData2?{data:_storageData2}:{})));softStorage.setItem(type,_ITEM2);if(_storageData2)store.dispatch(_storageData2);}else{var _store$getState2=store.getState(),_store$getState2$redu=_store$getState2.reduxStorage;_store$getState2$redu=_store$getState2$redu===undefined?{}:_store$getState2$redu;var _store$getState2$redu2=_store$getState2$redu[type];_store$getState2$redu2=_store$getState2$redu2===undefined?{}:_store$getState2$redu2;var _storageData3=_store$getState2$redu2.data;if(_storageData3)store.dispatch(_storageData3);}}}function storageStore(store,_ref13){var _ref13$meta=_ref13.meta;_ref13$meta=_ref13$meta===undefined?{}:_ref13$meta;var _ref13$meta$isHardSto=_ref13$meta.isHardStorage,isHardStorage=_ref13$meta$isHardSto===undefined?false:_ref13$meta$isHardSto,_ref13$meta$isSoftSto=_ref13$meta.isSoftStorage,isSoftStorage=_ref13$meta$isSoftSto===undefined?false:_ref13$meta$isSoftSto,type=_ref13$meta.type,meta=_objectWithoutProperties(_ref13$meta,['isHardStorage','isSoftStorage','type']),data=_ref13.data,action=_objectWithoutProperties(_ref13,['meta','data']);if(isHardStorage){var item=hardStorage.getItem(type);var _ref14=fromStringToObject(item)||{},_ref14$meta=_ref14.meta,storageMeta=_ref14$meta===undefined?{}:_ref14$meta,storageData=_ref14.data;var ITEM=fromObjectToString(_extends({meta:createMeta(_extends({},storageMeta,meta))},data?{data:data}:_extends({},storageData?{data:storageData}:{})));hardStorage.setItem(type,ITEM);}else{if(isSoftStorage){var _item4=softStorage.getItem(type);var _ref15=fromStringToObject(_item4)||{},_ref15$meta=_ref15.meta,_storageMeta3=_ref15$meta===undefined?{}:_ref15$meta,_storageData4=_ref15.data;var _ITEM3=fromObjectToString(_extends({meta:createMeta(_extends({},_storageMeta3,meta))},data?{data:data}:_extends({},_storageData4?{data:_storageData4}:{})));softStorage.setItem(type,_ITEM3);}}}function storageClear(store,_ref16){var _ref16$meta=_ref16.meta;_ref16$meta=_ref16$meta===undefined?{}:_ref16$meta;var _ref16$meta$isHardSto=_ref16$meta.isHardStorage,isHardStorage=_ref16$meta$isHardSto===undefined?false:_ref16$meta$isHardSto,_ref16$meta$isSoftSto=_ref16$meta.isSoftStorage,isSoftStorage=_ref16$meta$isSoftSto===undefined?false:_ref16$meta$isSoftSto,type=_ref16$meta.type,meta=_objectWithoutProperties(_ref16$meta,['isHardStorage','isSoftStorage','type']),action=_objectWithoutProperties(_ref16,['meta']);if(isHardStorage){hardStorage.removeItem(type);}else{if(isSoftStorage){softStorage.removeItem(type);}}}exports.default=function(store){return function(next){return function(action){var type=action.type;switch(type){case _actions.STORAGE_COMPARE:{var _action$meta=action.meta,cacheFor=_action$meta.cacheFor,cachedAt=_action$meta.cachedAt,comparator=_action$meta.comparator,then=_action$meta.then,ACTION=action.data;return comparator(get(store,action)||{},ACTION,_extends({cacheFor:cacheFor},cachedAt?{cachedAt:new Date(cachedAt)}:{}))?next(put(store,action)||ACTION):then(ACTION);}case _actions.STORAGE_FETCH:storageFetch(store,action);return next(action);case _actions.STORAGE_STORE:storageStore(store,action);return next(action);case _actions.STORAGE_CLEAR:storageClear(store,action);return next(action);default:return next(action);}};};};