'use strict';Object.defineProperty(exports,"__esModule",{value:true});exports.storageClearMiddleware=exports.storageStoreMiddleware=exports.storageFetchMiddleware=undefined;var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key];}}}return target;};var _actions=require('./actions');var _hardStorage=require('./components/storage/hard-storage');var _hardStorage2=_interopRequireDefault(_hardStorage);var _softStorage=require('./components/storage/soft-storage');var _softStorage2=_interopRequireDefault(_softStorage);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _objectWithoutProperties(obj,keys){var target={};for(var i in obj){if(keys.indexOf(i)>=0)continue;if(!Object.prototype.hasOwnProperty.call(obj,i))continue;target[i]=obj[i];}return target;}var hardStorage=(0,_hardStorage2.default)();var softStorage=(0,_softStorage2.default)();var fromObjectToString=function fromObjectToString(object){return JSON.stringify(object);};var fromStringToObject=function fromStringToObject(string){return JSON.parse(string);};var createType=function createType(_ref){var type=_ref.type,meta=_objectWithoutProperties(_ref,['type']);return _extends({},meta,type?{type:type}:{});};var createIsHardStorage=function createIsHardStorage(_ref2){var _ref2$isHardStorage=_ref2.isHardStorage,isHardStorage=_ref2$isHardStorage===undefined?false:_ref2$isHardStorage,meta=_objectWithoutProperties(_ref2,['isHardStorage']);return _extends({},meta,isHardStorage?{isHardStorage:isHardStorage}:{});};var createIsSoftStorage=function createIsSoftStorage(_ref3){var _ref3$isSoftStorage=_ref3.isSoftStorage,isSoftStorage=_ref3$isSoftStorage===undefined?false:_ref3$isSoftStorage,meta=_objectWithoutProperties(_ref3,['isSoftStorage']);return _extends({},meta,isSoftStorage?{isSoftStorage:isSoftStorage}:{});};var createMeta=function createMeta(){var meta=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};return createType(createIsHardStorage(createIsSoftStorage(meta)));};var storageFetch=function storageFetch(store,_ref4){var _ref4$meta=_ref4.meta;_ref4$meta=_ref4$meta===undefined?{}:_ref4$meta;var _ref4$meta$isHardStor=_ref4$meta.isHardStorage,isHardStorage=_ref4$meta$isHardStor===undefined?false:_ref4$meta$isHardStor,_ref4$meta$isSoftStor=_ref4$meta.isSoftStorage,isSoftStorage=_ref4$meta$isSoftStor===undefined?false:_ref4$meta$isSoftStor,type=_ref4$meta.type,META=_objectWithoutProperties(_ref4$meta,['isHardStorage','isSoftStorage','type']),action=_objectWithoutProperties(_ref4,['meta']);if(isHardStorage){var item=hardStorage.getItem(type);var _ref5=fromStringToObject(item)||{},data=_ref5.data;if(data)store.dispatch(data);}else{if(isSoftStorage){var _item=softStorage.getItem(type);var _ref6=fromStringToObject(_item)||{},_data=_ref6.data;if(_data)store.dispatch(_data);}else{var _store$getState=store.getState(),_store$getState$redux=_store$getState.reduxStorage;_store$getState$redux=_store$getState$redux===undefined?{}:_store$getState$redux;var _store$getState$redux2=_store$getState$redux[type];_store$getState$redux2=_store$getState$redux2===undefined?{}:_store$getState$redux2;var _data2=_store$getState$redux2.data;if(_data2)store.dispatch(_data2);}}return _extends({},action,{meta:createMeta(_extends({},META,{type:type,isHardStorage:isHardStorage,isSoftStorage:isSoftStorage}))});};var storageStore=function storageStore(store,_ref7){var _ref7$meta=_ref7.meta;_ref7$meta=_ref7$meta===undefined?{}:_ref7$meta;var _ref7$meta$isHardStor=_ref7$meta.isHardStorage,isHardStorage=_ref7$meta$isHardStor===undefined?false:_ref7$meta$isHardStor,_ref7$meta$isSoftStor=_ref7$meta.isSoftStorage,isSoftStorage=_ref7$meta$isSoftStor===undefined?false:_ref7$meta$isSoftStor,type=_ref7$meta.type,META=_objectWithoutProperties(_ref7$meta,['isHardStorage','isSoftStorage','type']),data=_ref7.data,action=_objectWithoutProperties(_ref7,['meta','data']);if(isHardStorage){var item=hardStorage.getItem(type);var _ref8=fromStringToObject(item)||{},_ref8$meta=_ref8.meta,meta=_ref8$meta===undefined?{}:_ref8$meta;var ITEM=fromObjectToString(_extends({meta:createMeta(_extends({},meta,META))},data?{data:data}:{}));hardStorage.setItem(type,ITEM);return _extends({},action,{meta:createMeta(_extends({},meta,META,{type:type,isHardStorage:isHardStorage,isSoftStorage:isSoftStorage}))},data?{data:data}:{});}else{if(isSoftStorage){var _item2=softStorage.getItem(type);var _ref9=fromStringToObject(_item2)||{},_ref9$meta=_ref9.meta,_meta=_ref9$meta===undefined?{}:_ref9$meta;var _ITEM=fromObjectToString(_extends({meta:createMeta(_extends({},_meta,META))},data?{data:data}:{}));softStorage.setItem(type,_ITEM);return _extends({},action,{meta:createMeta(_extends({},_meta,META,{type:type,isHardStorage:isHardStorage,isSoftStorage:isSoftStorage}))},data?{data:data}:{});}else{var _store$getState2=store.getState(),_store$getState2$redu=_store$getState2.reduxStorage;_store$getState2$redu=_store$getState2$redu===undefined?{}:_store$getState2$redu;var _store$getState2$redu2=_store$getState2$redu[type];_store$getState2$redu2=_store$getState2$redu2===undefined?{}:_store$getState2$redu2;var _meta2=_store$getState2$redu2.meta;return _extends({},action,{meta:createMeta(_extends({},_meta2,META,{type:type,isHardStorage:isHardStorage,isSoftStorage:isSoftStorage}))},data?{data:data}:{});}}};var storageClear=function storageClear(store,_ref10){var _ref10$meta=_ref10.meta;_ref10$meta=_ref10$meta===undefined?{}:_ref10$meta;var type=_ref10$meta.type,META=_objectWithoutProperties(_ref10$meta,['type']),action=_objectWithoutProperties(_ref10,['meta']);if(type){hardStorage.removeItem(type);softStorage.removeItem(type);return _extends({},action,{meta:_extends({type:type},META)});}return _extends({},action,{meta:META});};var storageFetchMiddleware=function storageFetchMiddleware(store){return function(next){return function(_ref11){var type=_ref11.type,action=_objectWithoutProperties(_ref11,['type']);return type===_actions.REDUX_STORAGE_FETCH?next(storageFetch(store,_extends({},action,{type:type}))):next(_extends({},action,{type:type}));};};};exports.storageFetchMiddleware=storageFetchMiddleware;var storageStoreMiddleware=function storageStoreMiddleware(store){return function(next){return function(_ref12){var type=_ref12.type,action=_objectWithoutProperties(_ref12,['type']);return type===_actions.REDUX_STORAGE_STORE?next(storageStore(store,_extends({},action,{type:type}))):next(_extends({},action,{type:type}));};};};exports.storageStoreMiddleware=storageStoreMiddleware;var storageClearMiddleware=function storageClearMiddleware(store){return function(next){return function(_ref13){var type=_ref13.type,action=_objectWithoutProperties(_ref13,['type']);return type===_actions.REDUX_STORAGE_CLEAR?next(storageClear(store)):next(_extends({},action,{type:type}));};};};exports.storageClearMiddleware=storageClearMiddleware;exports.default=function(store){return function(next){return function(_ref14){var type=_ref14.type,action=_objectWithoutProperties(_ref14,['type']);switch(type){case _actions.REDUX_STORAGE_FETCH:return next(storageFetch(store,_extends({},action,{type:type})));case _actions.REDUX_STORAGE_STORE:return next(storageStore(store,_extends({},action,{type:type})));case _actions.REDUX_STORAGE_CLEAR:return next(storageClear(store,_extends({},action,{type:type})));default:return next(_extends({},action,{type:type}));}};};};